<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lehrer-Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-white {
            background: white;
            color: #667eea;
        }
        
        .btn-white:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            color: #667eea;
            background: white;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .termine-liste {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .termin-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .termin-card .info {
            flex: 1;
        }
        
        .termin-card .info strong {
            color: #667eea;
            font-size: 16px;
        }
        
        .termin-card .actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        #loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .share-link {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .share-link h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .share-link .link-box {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .share-link input {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .antworten-liste {
            margin-top: 20px;
        }
        
        .antwort-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }
        
        .antwort-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .antwort-card .termine-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .termin-tag {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
        }
        
        .zuteilung-slot {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .zuteilung-slot h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .eltern-option {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .eltern-option:hover:not(.grayed-out) {
            border-color: #667eea;
        }
        
        .eltern-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .eltern-option.grayed-out {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .eltern-option input[type="radio"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>Wird geladen...</h2>
    </div>
    
    <div class="container" id="dashboard" style="display: none;">
        <div class="header">
            <div>
                <h1>üë®‚Äçüè´ Lehrer-Dashboard</h1>
                <p id="user-email" style="opacity: 0.9; margin-top: 5px;"></p>
            </div>
            <div class="header-actions">
                <button class="btn btn-white" onclick="helpers.logout()">Abmelden</button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('termine')">üìÖ Meine Termine</div>
            <div class="tab" onclick="switchTab('antworten')">üì® Eltern-Antworten (<span id="antworten-count">0</span>)</div>
            <div class="tab" onclick="switchTab('zuteilung')">‚úÖ Zuteilung</div>
            <div class="tab" onclick="switchTab('share')">üîó Link teilen</div>
            <div class="tab" onclick="switchTab('verwaltung')">‚öôÔ∏è Verwaltung</div>
        </div>
        
        <div class="content">
            <!-- Tab: Termine erstellen -->
            <div id="tab-termine" class="tab-content active">
                <h2>Termine erstellen</h2>
                <p style="color: #666; margin-bottom: 20px;">Erstellen Sie Termine f√ºr Elterngespr√§che.</p>
                
                <form id="termin-form" onsubmit="createTermin(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Datum *</label>
                            <input type="date" id="termin-datum" required>
                        </div>
                        <div class="form-group">
                            <label>Uhrzeit *</label>
                            <input type="time" id="termin-zeit" required>
                        </div>
                        <div class="form-group">
                            <label>Dauer (Min.) *</label>
                            <input type="number" id="termin-dauer" value="30" min="5" max="120" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="create-btn">Termin hinzuf√ºgen</button>
                </form>
                
                <div id="termine-message"></div>
                
                <h3 style="margin-top: 40px; margin-bottom: 15px;">Ihre Termine</h3>
                <div id="termine-liste" class="termine-liste"></div>
            </div>
            
            <!-- Tab: Zuteilung -->
            <div id="tab-zuteilung" class="tab-content">
                <h2>Termine zuteilen</h2>
                <p style="color: #666; margin-bottom: 20px;">Weisen Sie jedem Termin die gew√ºnschten Eltern zu.</p>
                
                <div class="alert alert-info">
                    <strong>Anleitung:</strong> Klicken Sie auf ein Kind, um es einem Termin zuzuteilen. Bereits zugeteilte Kinder werden bei anderen Terminen ausgegraut.
                </div>
                
                <div id="zuteilungs-area"></div>
                
                <button class="btn btn-success" id="save-zuteilungen-btn" onclick="saveZuteilungen()" style="margin-top: 20px;">‚úì Zuteilungen speichern</button>
                
                <div id="zuteilung-message"></div>
            </div>
            
            <!-- Tab: Antworten -->
            <div id="tab-antworten" class="tab-content">
                <h2>Eltern-Antworten</h2>
                <p style="color: #666; margin-bottom: 20px;">√úbersicht der Eltern, die ihre Verf√ºgbarkeit angegeben haben.</p>
                
                <div id="antworten-liste" class="antworten-liste"></div>
            </div>
            
            <!-- Tab: Link teilen -->
            <div id="tab-share" class="tab-content">
                <h2>Link mit Eltern teilen</h2>
                <p style="color: #666; margin-bottom: 20px;">Senden Sie diesen Link an die Eltern, damit sie ihre Verf√ºgbarkeit angeben k√∂nnen.</p>
                
                <div class="share-link">
                    <h3>üìé Eltern-Formular Link</h3>
                    <p style="margin: 10px 0; color: #666;">Kopieren Sie diesen Link und senden Sie ihn per E-Mail an die Eltern:</p>
                    <div class="link-box">
                        <input type="text" id="share-url" readonly>
                        <button class="btn btn-primary" onclick="copyShareLink()">Kopieren</button>
                    </div>
                </div>
                
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>üí° Tipp:</strong> Die Eltern brauchen kein Konto. Sie k√∂nnen direkt √ºber den Link ihre Verf√ºgbarkeit angeben.
                </div>
            </div>
            
            <!-- Tab: Verwaltung -->
            <div id="tab-verwaltung" class="tab-content">
                <h2>‚öôÔ∏è Verwaltung</h2>
                <p style="color: #666; margin-bottom: 20px;">Verwaltungsfunktionen f√ºr Ihre Elterngespr√§che.</p>
                
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Achtung:</strong> Diese Aktionen k√∂nnen nicht r√ºckg√§ngig gemacht werden!
                </div>
                
                <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">F√ºr neue Elterngespr√§ch-Runde vorbereiten</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        Verwenden Sie diese Funktion, wenn Sie eine neue Runde Elterngespr√§che starten m√∂chten.<br>
                        <strong>Was wird gel√∂scht:</strong>
                    </p>
                    <ul style="color: #666; margin-left: 20px; margin-bottom: 20px;">
                        <li>Alle Eltern-Antworten</li>
                        <li>Alle Zuteilungen</li>
                    </ul>
                    <p style="color: #666; margin-bottom: 20px;">
                        <strong>Was bleibt erhalten:</strong> Ihre Termine (werden wieder als verf√ºgbar markiert)
                    </p>
                    
                    <button class="btn btn-danger" onclick="resetAntworten()" style="background: #e74c3c;">
                        üóëÔ∏è Antworten & Zuteilungen l√∂schen
                    </button>
                </div>
                
                <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">Komplett neu starten</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        L√∂scht ALLES: Termine, Antworten und Zuteilungen.
                    </p>
                    
                    <button class="btn btn-danger" onclick="resetAlles()" style="background: #c0392b;">
                        üóëÔ∏è Alles l√∂schen (Termine, Antworten, Zuteilungen)
                    </button>
                </div>
                
                <div id="verwaltung-message" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allTermine = [];
        let allAntworten = [];
        let assignments = {}; // { antwortId: terminId }
        
        // Beim Laden pr√ºfen ob eingeloggt
        window.onload = async () => {
            currentUser = await helpers.checkAuth();
            
            if (!currentUser) {
                window.location.href = 'lehrer-login.html';
                return;
            }
            
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Share-URL setzen
            const baseUrl = window.location.origin + window.location.pathname.replace('lehrer-dashboard.html', '');
            const shareUrl = baseUrl + 'eltern-formular.html?teacher=' + currentUser.id;
            document.getElementById('share-url').value = shareUrl;
            
            // Daten laden
            await loadTermine();
            await loadAntworten();
        };
        
        function switchTab(tabName) {
            // Tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabIndex = { termine: 1, antworten: 2, zuteilung: 3, share: 4, verwaltung: 5 }[tabName];
            document.querySelector(`.tab:nth-child(${tabIndex})`).classList.add('active');
            
            // Content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Wenn Zuteilung ge√∂ffnet wird, lade die Daten
            if (tabName === 'zuteilung') {
                loadZuteilungsView();
            }
        }
        
        async function createTermin(e) {
            e.preventDefault();
            
            const datum = document.getElementById('termin-datum').value;
            const zeit = document.getElementById('termin-zeit').value;
            const dauer = document.getElementById('termin-dauer').value;
            const btn = document.getElementById('create-btn');
            
            btn.disabled = true;
            btn.textContent = 'Wird erstellt...';
            
            try {
                const { data, error } = await supabase
                    .from('termine')
                    .insert([{
                        user_id: currentUser.id,
                        datum: datum,
                        zeit: zeit,
                        dauer_minuten: parseInt(dauer),
                        ist_verfuegbar: true
                    }])
                    .select();
                
                if (error) throw error;
                
                showMessage('termine', '‚úì Termin erfolgreich erstellt!', 'success');
                
                // Formular zur√ºcksetzen
                document.getElementById('termin-form').reset();
                
                // Liste neu laden
                loadTermine();
                
            } catch (error) {
                showMessage('termine', 'Fehler: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Termin hinzuf√ºgen';
            }
        }
        
        async function loadTermine() {
            const liste = document.getElementById('termine-liste');
            liste.innerHTML = '<p style="color: #999;">Wird geladen...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('termine')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('datum', { ascending: true })
                    .order('zeit', { ascending: true });
                
                if (error) throw error;
                
                // Speichere Termine global
                allTermine = data || [];
                
                if (allTermine.length === 0) {
                    liste.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p>Noch keine Termine erstellt</p>
                        </div>
                    `;
                    return;
                }
                
                liste.innerHTML = allTermine.map(termin => {
                    const datum = new Date(termin.datum);
                    const formattedDate = datum.toLocaleDateString('de-CH', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    return `
                        <div class="termin-card">
                            <div class="info">
                                <strong>${formattedDate}, ${termin.zeit} Uhr</strong><br>
                                <span style="color: #666;">Dauer: ${termin.dauer_minuten} Minuten</span>
                            </div>
                            <div class="actions">
                                <button class="btn btn-danger btn-small" onclick="deleteTermin('${termin.id}')">L√∂schen</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                liste.innerHTML = `<div class="alert alert-error">Fehler beim Laden: ${error.message}</div>`;
            }
        }
        
        async function deleteTermin(id) {
            if (!confirm('Termin wirklich l√∂schen?')) return;
            
            try {
                const { error } = await supabase
                    .from('termine')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadTermine();
                
            } catch (error) {
                alert('Fehler beim L√∂schen: ' + error.message);
            }
        }
        
        async function loadAntworten() {
            const liste = document.getElementById('antworten-liste');
            liste.innerHTML = '<p style="color: #999;">Wird geladen...</p>';
            
            try {
                // Hole nur Antworten die zu meinen AKTUELLEN Terminen geh√∂ren
                const meinTerminIds = allTermine.map(t => t.id);
                
                if (meinTerminIds.length === 0) {
                    allAntworten = [];
                    document.getElementById('antworten-count').textContent = '0';
                    liste.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <p>Noch keine Antworten erhalten</p>
                        </div>
                    `;
                    return;
                }
                
                // Hole alle Antworten
                const { data, error } = await supabase
                    .from('antworten')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Filtere nur Antworten die zu aktuellen Terminen geh√∂ren
                const filteredAntworten = (data || []).filter(antwort => {
                    return antwort.verfuegbare_termine.some(terminId => meinTerminIds.includes(terminId));
                });
                
                // Speichere f√ºr Zuteilung
                allAntworten = filteredAntworten;
                
                document.getElementById('antworten-count').textContent = allAntworten.length;
                
                if (allAntworten.length === 0) {
                    liste.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <p>Noch keine Antworten erhalten</p>
                        </div>
                    `;
                    return;
                }
                
                liste.innerHTML = allAntworten.map(antwort => {
                    const terminTags = antwort.verfuegbare_termine
                        .filter(terminId => meinTerminIds.includes(terminId)) // Nur aktuelle Termine
                        .map(terminId => {
                            const termin = allTermine.find(t => t.id === terminId);
                            if (!termin) return '';
                            
                            const datum = new Date(termin.datum);
                            const formattedDate = datum.toLocaleDateString('de-CH', {
                                day: '2-digit',
                                month: '2-digit'
                            });
                            
                            return `<span class="termin-tag">${formattedDate} ${termin.zeit}</span>`;
                        }).join('');
                    
                    return `
                        <div class="antwort-card">
                            <h4>${antwort.kindname}</h4>
                            <p><strong>E-Mail:</strong> ${antwort.email}</p>
                            <p><strong>Verf√ºgbare Termine:</strong></p>
                            <div class="termine-tags">${terminTags || '<span style="color: #999;">Keine passenden Termine</span>'}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                liste.innerHTML = `<div class="alert alert-error">Fehler beim Laden: ${error.message}</div>`;
            }
        }
        
        async function loadZuteilungsView() {
            const area = document.getElementById('zuteilungs-area');
            area.innerHTML = '<p style="color: #999;">Wird geladen...</p>';
            
            if (allTermine.length === 0 || allAntworten.length === 0) {
                area.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Keine Daten vorhanden.</strong><br>
                        Bitte erstellen Sie zuerst Termine und warten Sie auf Eltern-Antworten.
                    </div>
                `;
                return;
            }
            
            // Lade bestehende Zuteilungen
            const { data: zuteilungen } = await supabase
                .from('zuteilungen')
                .select('*')
                .in('termin_id', allTermine.map(t => t.id)); // Nur f√ºr aktuelle Termine
            
            // Setze assignments basierend auf gespeicherten Zuteilungen
            assignments = {};
            if (zuteilungen) {
                zuteilungen.forEach(z => {
                    // Pr√ºfe ob die Antwort noch in unserer aktuellen Liste ist
                    const antwort = allAntworten.find(a => a.id === z.antwort_id);
                    if (antwort) {
                        assignments[z.antwort_id] = z.termin_id;
                    }
                });
            }
            
            renderZuteilungsArea();
        }
        
        function renderZuteilungsArea() {
            const area = document.getElementById('zuteilungs-area');
            area.innerHTML = '';
            
            allTermine.forEach(termin => {
                const datum = new Date(termin.datum);
                const formattedDate = datum.toLocaleDateString('de-CH', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const slotDiv = document.createElement('div');
                slotDiv.className = 'zuteilung-slot';
                slotDiv.innerHTML = `
                    <h3>${formattedDate}, ${termin.zeit} Uhr (${termin.dauer_minuten} Min.)</h3>
                    <div id="eltern-${termin.id}"></div>
                `;
                
                area.appendChild(slotDiv);
                
                const elternDiv = document.getElementById('eltern-' + termin.id);
                let hasOptions = false;
                
                allAntworten.forEach(antwort => {
                    if (antwort.verfuegbare_termine.includes(termin.id)) {
                        hasOptions = true;
                        
                        const isAssignedElsewhere = assignments[antwort.id] && assignments[antwort.id] !== termin.id;
                        const isSelected = assignments[antwort.id] === termin.id;
                        
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'eltern-option';
                        if (isSelected) optionDiv.classList.add('selected');
                        if (isAssignedElsewhere) optionDiv.classList.add('grayed-out');
                        
                        optionDiv.innerHTML = `
                            <input type="radio" name="antwort-${antwort.id}" value="${termin.id}" ${isSelected ? 'checked' : ''} ${isAssignedElsewhere ? 'disabled' : ''}>
                            <label>${antwort.kindname} (${antwort.email})</label>
                        `;
                        
                        optionDiv.onclick = function(e) {
                            if (!isAssignedElsewhere && !this.classList.contains('grayed-out')) {
                                if (isSelected) {
                                    // Zuteilung aufheben
                                    delete assignments[antwort.id];
                                } else {
                                    // Neue Zuteilung
                                    assignments[antwort.id] = termin.id;
                                }
                                renderZuteilungsArea();
                            }
                        };
                        
                        elternDiv.appendChild(optionDiv);
                    }
                });
                
                if (!hasOptions) {
                    elternDiv.innerHTML = '<p style="color: #999; font-style: italic;">Keine Eltern f√ºr diesen Termin verf√ºgbar</p>';
                }
            });
        }
        
        async function saveZuteilungen() {
            if (Object.keys(assignments).length === 0) {
                alert('Bitte teilen Sie mindestens einem Elternpaar einen Termin zu.');
                return;
            }

            const btn = document.getElementById('save-zuteilungen-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Wird gespeichert...';

            try {
                console.log('=== STARTE SPEICHERVORGANG ===');
                console.log('Assignments:', assignments);
                console.log('Meine Termin-IDs:', allTermine.map(t => t.id));

                // Schritt 1: Hole existierende Zuteilungen
                console.log('Schritt 1: Hole existierende Zuteilungen...');
                const { data: existingZuteilungen, error: fetchError } = await supabase
                    .from('zuteilungen')
                    .select('id, termin_id, antwort_id')
                    .in('termin_id', allTermine.map(t => t.id));

                if (fetchError) {
                    console.error('FEHLER beim Abrufen:', fetchError);
                    throw new Error('Fehler beim Abrufen der Zuteilungen: ' + fetchError.message);
                }

                console.log('Gefundene Zuteilungen:', existingZuteilungen);

                // Schritt 2: L√∂sche alte Zuteilungen einzeln (wichtig wegen RLS!)
                if (existingZuteilungen && existingZuteilungen.length > 0) {
                    console.log('Schritt 2: L√∂sche', existingZuteilungen.length, 'alte Zuteilungen...');

                    for (const zuteilung of existingZuteilungen) {
                        console.log('L√∂sche Zuteilung:', zuteilung.id);
                        const { error: deleteError } = await supabase
                            .from('zuteilungen')
                            .delete()
                            .eq('id', zuteilung.id);

                        if (deleteError) {
                            console.error('FEHLER beim L√∂schen von', zuteilung.id, ':', deleteError);
                            throw new Error('Fehler beim L√∂schen: ' + deleteError.message);
                        }
                    }
                    console.log('‚úì Alle alten Zuteilungen gel√∂scht');

                    // Warte kurz
                    await new Promise(resolve => setTimeout(resolve, 500));
                } else {
                    console.log('Keine alten Zuteilungen vorhanden');
                }

                // Schritt 3: Erstelle neue Zuteilungen
                console.log('Schritt 3: Erstelle neue Zuteilungen...');
                const zuteilungenData = Object.entries(assignments).map(([antwortId, terminId]) => ({
                    termin_id: terminId,
                    antwort_id: antwortId,
                    status: 'zugeteilt'
                }));

                console.log('Neue Zuteilungen (zu speichern):', zuteilungenData);

                if (zuteilungenData.length > 0) {
                    const { data: insertedData, error: insertError } = await supabase
                        .from('zuteilungen')
                        .insert(zuteilungenData)
                        .select();

                    if (insertError) {
                        console.error('FEHLER beim Einf√ºgen:', insertError);
                        throw new Error('Fehler beim Speichern: ' + insertError.message);
                    }

                    console.log('‚úì Neue Zuteilungen gespeichert:', insertedData);
                }

                // Schritt 4: Aktualisiere Verf√ºgbarkeit der Termine
                console.log('Schritt 4: Aktualisiere Termin-Verf√ºgbarkeit...');

                // Erst alle Termine auf verf√ºgbar setzen
                await supabase
                    .from('termine')
                    .update({ ist_verfuegbar: true })
                    .eq('user_id', currentUser.id);

                // Dann zugeteilte auf nicht verf√ºgbar
                const zugeteilteTerminIds = Object.values(assignments);
                if (zugeteilteTerminIds.length > 0) {
                    await supabase
                        .from('termine')
                        .update({ ist_verfuegbar: false })
                        .in('id', zugeteilteTerminIds);
                }

                console.log('‚úì Verf√ºgbarkeit aktualisiert');
                console.log('=== SPEICHERVORGANG ERFOLGREICH ===');

                // Zeige Erfolg und E-Mail/Kalender Optionen
                showEmailKalenderOptionen();

            } catch (error) {
                console.error('=== FEHLER ===');
                console.error('Fehlertyp:', error.name);
                console.error('Fehlermeldung:', error.message);
                console.error('Vollst√§ndiger Fehler:', error);

                showMessage('zuteilung', '‚ùå ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        function showEmailKalenderOptionen() {
            const messageDiv = document.getElementById('zuteilung-message');
            
            // Erstelle E-Mail-Vorlagen und Kalender-Downloads
            let html = '<div class="alert alert-success"><strong>‚úì Zuteilungen gespeichert!</strong></div>';
            
            html += '<div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-top: 20px;">';
            html += '<h3 style="margin-bottom: 15px; color: #667eea;">üìß E-Mail-Benachrichtigungen</h3>';
            html += '<p style="color: #666; margin-bottom: 20px;">Kopieren Sie die E-Mail-Texte und senden Sie sie an die Eltern:</p>';
            
            // F√ºr jeden zugeteilten Termin
            Object.keys(assignments).forEach(antwortId => {
                const antwort = allAntworten.find(a => a.id === antwortId);
                const termin = allTermine.find(t => t.id === assignments[antwortId]);
                
                if (!antwort || !termin) return;
                
                const datum = new Date(termin.datum);
                const formattedDate = datum.toLocaleDateString('de-CH', {
                    weekday: 'long',
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
                
                const emailText = `Guten Tag

Hiermit best√§tige ich den Termin f√ºr unser Elterngespr√§ch:

Kind: ${antwort.kindname}
Datum: ${formattedDate}
Uhrzeit: ${termin.zeit} Uhr
Dauer: ${termin.dauer_minuten} Minuten

Ich freue mich auf unser Gespr√§ch.

Mit freundlichen Gr√ºssen`;
                
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e0e0e0;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">${antwort.kindname}</h4>
                        <p style="margin-bottom: 10px;"><strong>An:</strong> ${antwort.email}</p>
                        <textarea readonly style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 13px; margin-bottom: 10px;">${emailText}</textarea>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary btn-small" onclick="copyEmailText(this)">üìã E-Mail-Text kopieren</button>
                            <button class="btn btn-primary btn-small" onclick="downloadICS('${antwortId}', '${termin.id}')">üìÖ Kalender-Datei (.ics)</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Gesamt-Kalender f√ºr Lehrperson
            html += '<div style="background: #e8f4f8; padding: 25px; border-radius: 8px; margin-top: 20px;">';
            html += '<h3 style="margin-bottom: 15px; color: #667eea;">üìÖ Ihre Termine (Gesamt-Kalender)</h3>';
            html += '<p style="color: #666; margin-bottom: 15px;">Laden Sie alle zugeteilten Termine als eine Kalender-Datei herunter:</p>';
            html += '<button class="btn btn-success" onclick="downloadAllICS()">üì• Alle Termine herunterladen (.ics)</button>';
            html += '</div>';
            
            // CSV Export
            html += '<div style="background: #fff3cd; padding: 25px; border-radius: 8px; margin-top: 20px;">';
            html += '<h3 style="margin-bottom: 15px; color: #856404;">üìä Export f√ºr Serien-E-Mail</h3>';
            html += '<p style="color: #856404; margin-bottom: 15px;">Exportieren Sie die Daten als CSV f√ºr Mail-Merge (z.B. in Outlook):</p>';
            html += '<button class="btn btn-primary" onclick="downloadCSV()">üì• Als CSV exportieren</button>';
            html += '</div>';
            
            messageDiv.innerHTML = html;
            
            // Button deaktivieren und Text √§ndern
            const btn = document.getElementById('save-zuteilungen-btn');
            btn.disabled = true;
            btn.textContent = '‚úì Gespeichert';
        }
        
        function copyEmailText(button) {
            const textarea = button.parentElement.previousElementSibling;
            textarea.select();
            document.execCommand('copy');
            
            const originalText = button.textContent;
            button.textContent = '‚úì Kopiert!';
            button.style.background = '#2ecc71';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
        }
        
        function downloadICS(antwortId, terminId) {
            const antwort = allAntworten.find(a => a.id === antwortId);
            const termin = allTermine.find(t => t.id === terminId);
            
            if (!antwort || !termin) return;
            
            const icsContent = generateICS(termin, antwort);
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Elterngespraech_${antwort.kindname.replace(/\s+/g, '_')}.ics`;
            link.click();
        }
        
        function downloadAllICS() {
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Elterngespr√§ch-Planer//DE
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Elterngespr√§che
X-WR-TIMEZONE:Europe/Zurich
`;
            
            Object.keys(assignments).forEach(antwortId => {
                const antwort = allAntworten.find(a => a.id === antwortId);
                const termin = allTermine.find(t => t.id === assignments[antwortId]);
                
                if (!antwort || !termin) return;
                
                const event = generateICSEvent(termin, antwort);
                icsContent += event;
            });
            
            icsContent += 'END:VCALENDAR';
            
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Elterngespraeche_Alle.ics';
            link.click();
        }
        
        function generateICS(termin, antwort) {
            const event = generateICSEvent(termin, antwort);
            
            return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Elterngespr√§ch-Planer//DE
CALSCALE:GREGORIAN
METHOD:PUBLISH
${event}END:VCALENDAR`;
        }
        
        function generateICSEvent(termin, antwort) {
            const datum = new Date(termin.datum + 'T' + termin.zeit);
            const endDatum = new Date(datum.getTime() + termin.dauer_minuten * 60000);
            
            const formatICSDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const uid = `elterngespraech-${termin.id}-${antwort.id}@elterngespraeche.app`;
            const dtstamp = formatICSDate(new Date());
            const dtstart = formatICSDate(datum);
            const dtend = formatICSDate(endDatum);
            
            return `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:Elterngespr√§ch - ${antwort.kindname}
DESCRIPTION:Elterngespr√§ch mit den Eltern von ${antwort.kindname}
LOCATION:Schule
STATUS:CONFIRMED
SEQUENCE:0
END:VEVENT
`;
        }
        
        function downloadCSV() {
            let csv = 'Kindname,Email,Datum,Uhrzeit,Dauer\n';
            
            Object.keys(assignments).forEach(antwortId => {
                const antwort = allAntworten.find(a => a.id === antwortId);
                const termin = allTermine.find(t => t.id === assignments[antwortId]);
                
                if (!antwort || !termin) return;
                
                const datum = new Date(termin.datum);
                const formattedDate = datum.toLocaleDateString('de-CH');
                
                csv += `"${antwort.kindname}","${antwort.email}","${formattedDate}","${termin.zeit}","${termin.dauer_minuten} Min."\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Elterngespraeche_Export.csv';
            link.click();
        }
        
        function copyShareLink() {
            const input = document.getElementById('share-url');
            input.select();
            document.execCommand('copy');
            alert('‚úì Link kopiert! Sie k√∂nnen ihn jetzt in eine E-Mail einf√ºgen.');
        }
        
        function showMessage(tab, text, type) {
            const messageDiv = document.getElementById(tab + '-message');
            messageDiv.innerHTML = `<div class="alert alert-${type}" style="margin-top: 20px;">${text}</div>`;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }
        
        async function resetAntworten() {
            if (!confirm('‚ö†Ô∏è ACHTUNG!\n\nDies l√∂scht ALLE Eltern-Antworten und Zuteilungen.\nIhre Termine bleiben erhalten.\n\nWirklich fortfahren?')) {
                return;
            }
            
            if (!confirm('Sind Sie WIRKLICH sicher? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!')) {
                return;
            }
            
            try {
                // L√∂sche alle Zuteilungen
                await supabase
                    .from('zuteilungen')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // L√∂scht alle
                
                // L√∂sche alle Antworten
                await supabase
                    .from('antworten')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // L√∂scht alle
                
                // Setze alle Termine wieder auf verf√ºgbar
                await supabase
                    .from('termine')
                    .update({ ist_verfuegbar: true })
                    .eq('user_id', currentUser.id);
                
                showMessage('verwaltung', '‚úì Erfolgreich! Alle Antworten und Zuteilungen wurden gel√∂scht. Ihre Termine sind wieder verf√ºgbar.', 'success');
                
                // Aktualisiere die Ansichten - WICHTIG: Neu laden aus DB!
                allAntworten = [];
                assignments = {};
                document.getElementById('antworten-count').textContent = '0';
                
                // Liste sofort leeren
                const liste = document.getElementById('antworten-liste');
                liste.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <p>Noch keine Antworten erhalten</p>
                    </div>
                `;
                
                // Zuteilungs-Bereich auch leeren
                const zuteilungsArea = document.getElementById('zuteilungs-area');
                if (zuteilungsArea) {
                    zuteilungsArea.innerHTML = '';
                }
                
            } catch (error) {
                showMessage('verwaltung', 'Fehler: ' + error.message, 'error');
            }
        }
        
        async function resetAlles() {
            if (!confirm('‚ö†Ô∏è‚ö†Ô∏è ACHTUNG! ‚ö†Ô∏è‚ö†Ô∏è\n\nDies l√∂scht ALLES:\n- Alle Termine\n- Alle Eltern-Antworten\n- Alle Zuteilungen\n\nWirklich ALLES l√∂schen?')) {
                return;
            }
            
            if (!confirm('LETZTE WARNUNG!\n\nSie l√∂schen wirklich ALLE Ihre Daten.\nDies kann NICHT r√ºckg√§ngig gemacht werden!\n\nFortfahren?')) {
                return;
            }
            
            try {
                // L√∂sche in der richtigen Reihenfolge (wegen Foreign Keys)
                await supabase
                    .from('zuteilungen')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000');
                
                await supabase
                    .from('antworten')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000');
                
                await supabase
                    .from('termine')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                showMessage('verwaltung', '‚úì Erfolgreich! Alle Daten wurden gel√∂scht. Sie k√∂nnen jetzt von vorne beginnen.', 'success');
                
                // Aktualisiere die Ansichten
                allTermine = [];
                allAntworten = [];
                assignments = {};
                document.getElementById('antworten-count').textContent = '0';
                
                // Leere alle Listen
                document.getElementById('termine-liste').innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p>Noch keine Termine erstellt</p>
                    </div>
                `;
                
                document.getElementById('antworten-liste').innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <p>Noch keine Antworten erhalten</p>
                    </div>
                `;
                
                const zuteilungsArea = document.getElementById('zuteilungs-area');
                if (zuteilungsArea) {
                    zuteilungsArea.innerHTML = '';
                }
                
            } catch (error) {
                showMessage('verwaltung', 'Fehler: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>